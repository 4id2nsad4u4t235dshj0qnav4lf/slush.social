<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile – slush.social</title>
  <link rel="stylesheet" href="css/app.css" />
  <link rel="apple-touch-icon" href="/icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#ffffff" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Birthstone&display=swap');
    
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    
    .birthstone-regular {
      font-family: "Birthstone", cursive;
      font-weight: 400;
      font-style: normal;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .header {
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .subtle {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .button {
      background: white;
      border: 1px solid black;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: black;
      transition: background 0.2s ease, color 0.2s ease;
      box-shadow: 0px 0px 15px lightgray;
    }
    
    .button:hover {
      background: #000;
      color: #fff;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .hidden { display: none; }
    .mt16 { margin-top: 16px; }
    .mt24 { margin-top: 24px; }
    
    .input, textarea {
      width: 100%;
      padding: 12px 14px;
      margin-top: 8px;
      border: 1px solid #000;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .input:focus, textarea:focus {
      border-color: #007aff;
      outline: none;
    }
    
    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .comment {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: #f9f9f9;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .comment-text {
      margin-bottom: 12px;
      line-height: 1.5;
    }
    
    .comment-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .vote-button {
      background: none;
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .vote-button:hover {
      background: #f0f0f0;
    }
    
    .vote-count {
      font-weight: 500;
      margin: 0 8px;
    }
    
    .delete-button {
      background: #ff4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .delete-button:hover {
      background: #cc3333;
    }
    
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .popup-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      color: #ff4444;
      text-align: center;
      padding: 20px;
    }
    
    .back-button {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="button back-button" onclick="window.location.href='index.html'">← Back to Home</button>
    
    <h1 class="header birthstone-regular">slush.social</h1>
    
    <!-- Loading State -->
    <div id="loading" class="loading">
      Loading...
    </div>
    
    <!-- Error State -->
    <div id="error" class="error hidden">
      <p>Error loading profile. Please try again.</p>
    </div>
    
    <!-- Profile Section -->
    <section id="profile-section" class="card hidden">
      <h2 id="profile-name">Loading...</h2>
      <p id="profile-info" class="subtle"></p>
    </section>
    
    <!-- Comments Section -->
    <section id="comments-section" class="card hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Comments</h3>
        <button id="write-comment-btn" class="button">Write Comment</button>
      </div>
      
      <div id="comments-list"></div>
      
      <div id="no-comments" class="hidden" style="text-align: center; color: #666; padding: 40px;">
        No comments yet. Be the first to write one!
      </div>
    </section>
    
    <!-- Comment Popup -->
    <div id="comment-popup" class="popup" style="display: none;">
      <div class="popup-content">
        <div class="popup-header">
          <h3>Write a Comment</h3>
          <button class="close-button" id="close-popup">&times;</button>
        </div>
        
        <form id="comment-form">
          <textarea id="comment-text" rows="4" placeholder="Write your comment..." required></textarea>
          
          <div class="g-recaptcha" data-sitekey="6LdxApwqAAAAAOoqUMpbGVdRmFYT8_pjt70cFBJO" style="margin: 16px 0;"></div>
          
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" class="button" id="submit-comment">Post Comment</button>
            <button type="button" class="button" id="cancel-comment" onclick="hideCommentPopup(); return false;">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAbMi_EGObuHNg3hQ49ZwvG2xNKHKDjDas",
      authDomain: "slushsocial-ec21f.firebaseapp.com",
      projectId: "slushsocial-ec21f",
      storageBucket: "slushsocial-ec21f.firebasestorage.app",
      messagingSenderId: "154904967675",
      appId: "1:154904967675:web:a021c424b5afeb462a335e",
      measurementId: "G-EGHWV0WPXE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // API base URL
    const API_BASE = 'https://slushbackend-production.up.railway.app';

    // Global variables
    let currentUser = null;
    let targetUserId = null;
    let isMyComments = false;
    let comments = [];

    // Helper function to get Firebase ID token
    async function getIdToken() {
      if (!currentUser) return null;
      return await currentUser.getIdToken();
    }

    // Helper function to make API calls
    async function apiCall(endpoint, options = {}) {
      const token = await getIdToken();
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'API call failed');
      }
      
      return response.json();
    }

    // Format time ago
    function timeAgo(timestamp) {
      const now = Date.now();
      let t = timestamp;
      if (timestamp && timestamp.seconds) t = timestamp.seconds * 1000;
      if (timestamp instanceof Date) t = timestamp.getTime();
      const diff = Math.floor((now - t) / 1000);

      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    // Load comments
    async function loadComments() {
      try {
        let result;
        if (isMyComments) {
          result = await apiCall('/api/my-comments');
        } else {
          if (!targetUserId) {
            throw new Error('No target user ID provided');
          }
          result = await apiCall(`/api/get-comments?user_id=${targetUserId}`);
        }
        
        comments = result.comments || [];
        displayComments();
      } catch (error) {
        console.error('Error loading comments:', error);
        // Show a more user-friendly error
        const commentsList = document.getElementById('comments-list');
        const noComments = document.getElementById('no-comments');
        commentsList.innerHTML = '';
        noComments.classList.remove('hidden');
        noComments.innerHTML = '<p>Error loading comments. Please try again.</p>';
      }
    }

    // Display comments
    function displayComments() {
      const commentsList = document.getElementById('comments-list');
      const noComments = document.getElementById('no-comments');
      
      if (comments.length === 0) {
        commentsList.innerHTML = '';
        noComments.classList.remove('hidden');
        return;
      }
      
      noComments.classList.add('hidden');
      commentsList.innerHTML = comments.map(comment => `
        <div class="comment" data-comment-id="${comment.id}">
          <div class="comment-header">
            <span class="time">${timeAgo(comment.created_at)}</span>
            ${isMyComments ? `<button class="delete-button" onclick="deleteComment('${comment.id}')">Delete</button>` : ''}
          </div>
          <div class="comment-text">${escapeHtml(comment.text)}</div>
          <div class="comment-actions">
            <button class="vote-button" onclick="voteComment('${comment.id}', 'upvote')">👍</button>
            <span class="vote-count">${comment.upvotes || 0}</span>
            <button class="vote-button" onclick="voteComment('${comment.id}', 'downvote')">👎</button>
            <span class="vote-count">${comment.downvotes || 0}</span>
          </div>
        </div>
      `).join('');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Vote on comment
    async function voteComment(commentId, voteType) {
      try {
        await apiCall('/api/vote-comment', {
          method: 'POST',
          body: JSON.stringify({ comment_id: commentId, vote_type: voteType })
        });
        
        // Reload comments to show updated vote counts
        await loadComments();
      } catch (error) {
        alert(`Error voting: ${error.message}`);
      }
    }

    // Delete comment
    async function deleteComment(commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) return;
      
      try {
        await apiCall(`/api/delete-comment?comment_id=${commentId}`, {
          method: 'DELETE'
        });
        
        // Reload comments
        await loadComments();
      } catch (error) {
        alert(`Error deleting comment: ${error.message}`);
      }
    }

    // Show comment popup
    function showCommentPopup() {
      console.log('Showing comment popup');
      document.getElementById('comment-popup').style.display = 'flex';
    }

    // Hide comment popup
    function hideCommentPopup() {
      console.log('Hiding comment popup');
      document.getElementById('comment-popup').style.display = 'none';
      document.getElementById('comment-text').value = '';
      grecaptcha.reset();
    }

    // Submit comment
    async function submitComment() {
      const text = document.getElementById('comment-text').value.trim();
      if (!text) {
        alert('Please enter a comment.');
        return;
      }
      
      const captchaResponse = grecaptcha.getResponse();
      if (!captchaResponse) {
        alert('Please complete the captcha.');
        return;
      }
      
      try {
        // For "my comments" page, we need to get the current user's ID
        let userId = targetUserId;
        if (isMyComments) {
          // Get current user's ID from the API
          const userProfile = await apiCall('/api/user-profile');
          // We need to get the user ID from the token, but for now let's disable commenting on self
          alert('You cannot comment on yourself. Use the "View Someone\'s Profile" feature to comment on others.');
          return;
        }
        
        if (!userId) {
          alert('Error: No target user specified');
          return;
        }
        
        await apiCall('/api/post-comment', {
          method: 'POST',
          body: JSON.stringify({
            target_user_id: userId,
            text: text,
            captcha_response: captchaResponse
          })
        });
        
        alert('Comment posted successfully!');
        hideCommentPopup();
        await loadComments();
      } catch (error) {
        alert(`Error posting comment: ${error.message}`);
      }
    }

    // Show error
    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
    }

    // Initialize page
    async function init() {
      // Ensure comment popup is hidden on page load
      document.getElementById('comment-popup').style.display = 'none';
      
      const urlParams = new URLSearchParams(window.location.search);
      targetUserId = urlParams.get('user_id');
      isMyComments = urlParams.get('my_comments') === 'true';
      
      if (!targetUserId && !isMyComments) {
        showError();
        return;
      }
      
      // Wait for auth state
      return new Promise((resolve) => {
        onAuthStateChanged(auth, async (user) => {
          currentUser = user;
          if (!user) {
            alert('Please sign in first.');
            window.location.href = 'index.html';
            return;
          }
          
          try {
            if (isMyComments) {
              document.getElementById('profile-name').textContent = 'Comments About Me';
              document.getElementById('profile-info').textContent = 'Here are all the comments people have written about you.';
              // Hide the write comment button for "my comments" page
              document.getElementById('write-comment-btn').style.display = 'none';
            } else {
              // Get user info
              const userResult = await apiCall(`/api/get-comments?user_id=${targetUserId}`);
              document.getElementById('profile-name').textContent = 'User Profile';
              document.getElementById('profile-info').textContent = userResult.user_verified ? 
                'This user has verified their account.' : 
                'This user has not verified their account yet. Comments will be visible when they sign up.';
              // Show the write comment button for other users
              document.getElementById('write-comment-btn').style.display = 'block';
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            document.getElementById('comments-section').classList.remove('hidden');
            
            await loadComments();
            resolve();
          } catch (error) {
            console.error('Error initializing:', error);
            // Show a more user-friendly error
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error').innerHTML = '<p>Error loading profile. Please try again.</p>';
          }
        });
      });
    }

    // Event listeners
    document.getElementById('write-comment-btn').addEventListener('click', showCommentPopup);
    document.getElementById('close-popup').addEventListener('click', hideCommentPopup);
    document.getElementById('cancel-comment').addEventListener('click', hideCommentPopup);
    document.getElementById('comment-form').addEventListener('submit', (e) => {
      e.preventDefault();
      submitComment();
    });

    // Make functions global for onclick handlers
    window.voteComment = voteComment;
    window.deleteComment = deleteComment;

    // Initialize
    init();
  </script>
</body>
</html>
